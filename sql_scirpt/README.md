#Database Back-End

There are several generated/hand-written SQL scripts in this directory.

What you need are:
1. A MySQL 5.5 server on your computer or on a remoted server;
2. A root/administrator user in the MySQL server;
3. A new user without any previliges.

Log in with the root/administrator user and please call the scripts in the following order to construct the database back-end.

##create_db.sql

This script simply creates the database 'DBChat', and uses it.

##build_db.sql

This script is generated by PowerDesigner. It creates all tables in the database, and set the primary keys and foreign keys.

##build_db_alter.sql

Because PowerDesigner only allows some table settings during PDM, instead of CDM, but when CDM changes, the old PDM cannot merge with the new one, it would cause trouble for altering the table. This script helps to alter the table. When new columns added on CDM, the old alterations would still remain in this script.

##auto_event.sql

Auto events are defined in this script.

**PURGE_EVENT** purges those inactive or old clients (inactive for a month), sessions (inactive for a week), messages (created for a week) and friend-applications (inactive for a week) everyday. Notice that all active time updates whever the client/session is operated.

##user_procedure.sql

Procedures for clients (users) are defined in this script. Notice that all possible and allowable behaviors of an user are defined with a stored-procedure.

**USER_SIGN_UP** creates a new user with a given name and a given password, and returns the CID of this user. Notice that CID is the only identification of an user.

**USER_SIGN_IN** verifies the user's CID and password. Notice that all procedures requires the user to provide his/her CID and password, and this procedure only indicates whether the CID and passwod is valid or not.

**USER_SIGN_OUT** deletes all records of the user, if granted.

**USER_GET_NAME** helps to get the name of the user, if granted.

**USER_RENAME** renames the user, if granted.

**USER_SEARCH** searches for users with a certain name, and returns their CIDs and names, if granted.

**USER_CHANGE_PASSWORD** changes password of the user, if granted.

**USER_GET_FRIEND** returns CIDs and names of all friends of the user, if granted.

**USER_FRIEND_APPLICATION** generates a friend application record from the user to another user, and returns the FAID of the friend application record, if granted.

**USER_GET_FRIEND_APPLICATION** gets FAIDs, senders' CIDs and senders' names of all friend applications sent to the user, if granted.

**USER_ACCEPT_FRIEND_APPLICATION** accepts a friend application from some other user and befriend with him/her, if granted.

**USER_REFUSE_FRIEND_APPLICATION** refuses a friend application from some other user, if granted.

**USER_DELETE_FRIEND** deletes a friend record with some other users, if granted.

##session_procedure.sql

Procedures for sessions are defined in this script. Notice that all possible and allowable behaviors about sessions of an user are defined with a stored-procedure.

**SESSION_CREATE_FRIEND** creates an invisible session for a pair of chatters, and returns the SID of this session, if granted. Inivisible session, which is unable to be found, unable to join, and unable to invite other users, is for and only for pair chatters. There is a manager in the invisible pair session, yet having no previliges at all.

**SESSION_CREATE** creates a visible session for a group of chatters, and returns the SID of this session, if granted. Visible session has no limitation upon the number of users. There must be a manager (the creator by default), and the manager cannot leave the session (only when he/she give the manager to some other users in the session can he/she leave the session), but has the ability to dismiss the session.

**SESSION_SEARCH** searches for visible sessions by name, and returns the SIDs, session names, CIDs and names of the managers, if granted. Invisible pair sessions are not accessible.

**SESSION_JOIN** allows a user to join a visible group session using the password, if granted. Invisible pair sessions are not accessible. If the user is already in the session, ignore.

**SESSION_INVITE** invites a friend of the user into a session without password, if granted. Invisible pair sessions are not accesible. The user invited must be friend with invitation initiator. If the user is already in the session, ignore.

**SESSION_GET_OTHERS_INSESSION** gets CIDs, names and if he/she is the manager of other users in the session, if granted.

**SESSION_GET_MY_SESSION** gets SIDs, session names and if the user if the manager of all sessions which he/she is in, if granted. Notice that invisible sessions have no actual managers, so the manager column is TRUE if the corresponding session is invisible.

**SESSION_CHANGE_MANAGER** allows the manager to give his/her previliges to some other user in the session, if granted. The manager has to give up the manager position first, and then is allowed to leave the session.

**SESSION_DESTROY** dismisses the session if the user is the manager of the session, or the session is an invisible pair session, if granted.

**SESSION_LEAVE** allows a non-manager user to leave a visible session, if granted. Users in an invisible session are actually both managers, so they can only dismiss the session, but none of them are allowed to leave.

##session_procedure.sql

Procedures for messages are defined in this script. Notice that all possible and allowable behaviors about messages of an user in a session are defined with a stored-procedure.

**MSG_SEND** sends a message into a session, if granted.

**MSG_GET** gets MIDs, senders' CIDs, text contents and sending time of all messages in a session, if granted.

**MSG_DELETE** deletes a message sent by the user, allowing him/her to retrieve what he/she sent before, if granted.